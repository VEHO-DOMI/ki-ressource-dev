<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epidemie-Simulation - Interaktiv</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0a0a1a 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
        }

        header {
            text-align: center;
            padding: 12px 20px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(231, 76, 60, 0.1);
        }

        h1 {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #e74c3c, #f39c12, #2ecc71);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            color: rgba(255,255,255,0.4);
            font-weight: 300;
            font-size: 0.75em;
            display: none;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 12px;
            height: calc(100vh - 68px);
            min-height: 500px;
            padding: 12px;
            overflow: hidden;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .main-grid {
            display: contents;
        }

        .simulation-area {
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            padding: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: radial-gradient(ellipse at center, #0f1525 0%, #050510 100%);
            border-radius: 8px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            flex: 1;
            width: 100%;
            height: 100%;
        }

        /* R-Value Display */
        .r-value-display {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 0.75em;
            flex-shrink: 0;
        }

        .r-box {
            text-align: center;
            flex: 1;
        }

        .r-label {
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.3);
            margin-bottom: 2px;
        }

        .r-value {
            font-size: 1.3em;
            font-weight: 700;
        }

        .r-value.high { color: #e74c3c; }
        .r-value.medium { color: #f39c12; }
        .r-value.low { color: #2ecc71; }

        .r-indicator {
            font-size: 0.6em;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 2px;
            display: inline-block;
        }

        .r-indicator.spreading { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .r-indicator.stable { background: rgba(243, 156, 18, 0.2); color: #f39c12; }
        .r-indicator.declining { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }

        /* Herd Immunity Bar */
        .herd-immunity-section {
            margin: 6px 0;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            flex-shrink: 0;
            display: none;
        }

        .herd-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7em;
        }

        .herd-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .herd-progress {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            border-radius: 6px;
            transition: width 0.5s;
        }

        .herd-threshold {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #fff;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }

        .herd-threshold-label {
            position: absolute;
            top: -18px;
            transform: translateX(-50%);
            font-size: 0.6em;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 4px 0;
            flex-wrap: wrap;
            font-size: 0.65em;
            flex-shrink: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 6px currentColor;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(231, 76, 60, 0.15);
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .control-panel::-webkit-scrollbar {
            width: 4px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: rgba(231, 76, 60, 0.3);
            border-radius: 4px;
        }

        .panel-title {
            font-size: 0.6em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.3);
            margin-bottom: 4px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .panel-title:first-child {
            margin-top: 0;
        }

        .day-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 6px 10px;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(46, 204, 113, 0.05));
            border-radius: 8px;
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .day-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #e74c3c;
        }

        .day-label {
            font-size: 0.65em;
            color: rgba(255,255,255,0.4);
        }

        /* Stats Grid - Compact Horizontal */
        .stats-grid {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .stat-card {
            flex: 1;
            padding: 4px 2px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card.healthy { background: rgba(46, 204, 113, 0.15); border: 1px solid rgba(46, 204, 113, 0.3); }
        .stat-card.infected { background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.3); }
        .stat-card.recovered { background: rgba(52, 152, 219, 0.15); border: 1px solid rgba(52, 152, 219, 0.3); }
        .stat-card.vaccinated { background: rgba(155, 89, 182, 0.15); border: 1px solid rgba(155, 89, 182, 0.3); }
        .stat-card.dead { background: rgba(127, 140, 141, 0.15); border: 1px solid rgba(127, 140, 141, 0.3); }

        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        .stat-card.healthy .stat-value { color: #2ecc71; }
        .stat-card.infected .stat-value { color: #e74c3c; }
        .stat-card.recovered .stat-value { color: #3498db; }
        .stat-card.vaccinated .stat-value { color: #9b59b6; }
        .stat-card.dead .stat-value { color: #7f8c8d; }

        .stat-label {
            font-size: 0.5em;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Sliders - Compact */
        .sliders-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 6px;
        }

        .slider-group {
            padding: 5px 6px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            gap: 2px;
        }

        .slider-label {
            font-size: 0.6em;
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .slider-value {
            font-weight: 600;
            color: #e74c3c;
            font-size: 0.6em;
            white-space: nowrap;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            border-radius: 2px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            border: none;
        }

        #infectionRate { background: linear-gradient(90deg, #2ecc71, #e74c3c); }
        #recoveryTime { background: linear-gradient(90deg, #e74c3c, #3498db); }
        #mortalityRate { background: linear-gradient(90deg, #3498db, #7f8c8d); }
        #vaccinationRate { background: linear-gradient(90deg, #7f8c8d, #9b59b6); }
        #socialDistance { background: linear-gradient(90deg, #e74c3c, #2ecc71); }

        /* Buttons - Compact */
        .btn-row {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .btn {
            flex: 1;
            padding: 6px 4px;
            border: none;
            border-radius: 6px;
            font-size: 0.65em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover { transform: translateY(-1px); }

        .btn.primary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }

        .btn.vaccine {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }

        .btn.quarantine {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        /* Graph - Compact */
        .graph-container {
            margin-top: 4px;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .graph-title {
            font-size: 0.6em;
            color: rgba(255,255,255,0.3);
            margin-bottom: 2px;
        }

        #graphCanvas {
            width: 100%;
            height: 50px;
            border-radius: 4px;
        }

        /* Info Footer */
        .info-footer {
            display: none;
        }

        /* Scenario Buttons - Compact */
        .scenario-section {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }

        .scenario-btn {
            padding: 4px 2px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: rgba(255,255,255,0.6);
            font-size: 0.55em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scenario-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Epidemie-Simulation</h1>
            <p class="subtitle">Krankheitsausbreitung & Schutzma√ünahmen</p>
        </header>

        <div class="main-layout main-grid">
            <div class="simulation-area">
                <canvas id="simCanvas" width="600" height="450"></canvas>

                <div class="r-value-display">
                    <div class="r-box">
                        <div class="r-label">Reproduktionszahl</div>
                        <div class="r-value high" id="rValue">2.5</div>
                        <div class="r-indicator spreading" id="rIndicator">Ausbreitung</div>
                    </div>
                    <div class="r-box">
                        <div class="r-label">Aktive F√§lle</div>
                        <div class="r-value" id="activeCases" style="color: #e74c3c;">1</div>
                        <div class="r-indicator" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">Infiziert</div>
                    </div>
                    <div class="r-box">
                        <div class="r-label">Peak erreicht</div>
                        <div class="r-value" id="peakCases" style="color: #f39c12;">-</div>
                        <div class="r-indicator" style="background: rgba(243, 156, 18, 0.2); color: #f39c12;">Tag -</div>
                    </div>
                </div>

                <div class="herd-immunity-section">
                    <div class="herd-label">
                        <span>üõ°Ô∏è Immunit√§t in der Bev√∂lkerung</span>
                        <span id="immunityPercent">0%</span>
                    </div>
                    <div class="herd-bar">
                        <div class="herd-progress" id="herdProgress" style="width: 0%"></div>
                        <div class="herd-threshold" id="herdThreshold" style="left: 70%">
                            <span class="herd-threshold-label">Herdenimmunit√§t (~70%)</span>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background: #2ecc71; color: #2ecc71;"></div> Gesund</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #e74c3c; color: #e74c3c;"></div> Infiziert</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #3498db; color: #3498db;"></div> Genesen</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #9b59b6; color: #9b59b6;"></div> Geimpft</div>
                    <div class="legend-item"><div class="legend-dot" style="background: #7f8c8d; color: #7f8c8d;"></div> Verstorben</div>
                </div>
            </div>

            <div class="control-panel">
                <div class="day-counter">
                    <div class="day-label">Tag</div>
                    <div class="day-value" id="dayCount">0</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card healthy">
                        <div class="stat-value" id="healthyCount">99</div>
                        <div class="stat-label">Gesund</div>
                    </div>
                    <div class="stat-card infected">
                        <div class="stat-value" id="infectedCount">1</div>
                        <div class="stat-label">Infiziert</div>
                    </div>
                    <div class="stat-card recovered">
                        <div class="stat-value" id="recoveredCount">0</div>
                        <div class="stat-label">Genesen</div>
                    </div>
                    <div class="stat-card vaccinated">
                        <div class="stat-value" id="vaccinatedCount">0</div>
                        <div class="stat-label">Geimpft</div>
                    </div>
                </div>

                <div class="panel-title">‚öôÔ∏è Parameter</div>
                <div class="sliders-container">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">ü¶† Ansteckung</span>
                            <span class="slider-value" id="infectionValue">50%</span>
                        </div>
                        <input type="range" id="infectionRate" min="10" max="100" value="50">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">‚è±Ô∏è Dauer</span>
                            <span class="slider-value" id="recoveryValue">14d</span>
                        </div>
                        <input type="range" id="recoveryTime" min="5" max="30" value="14">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">üíÄ Sterblichkeit</span>
                            <span class="slider-value" id="mortalityValue">2%</span>
                        </div>
                        <input type="range" id="mortalityRate" min="0" max="20" value="2">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">‚ÜîÔ∏è Distancing</span>
                            <span class="slider-value" id="distanceValue">0%</span>
                        </div>
                        <input type="range" id="socialDistance" min="0" max="90" value="0">
                    </div>

                    <div class="slider-group" style="grid-column: span 2;">
                        <div class="slider-header">
                            <span class="slider-label">üíâ Impfrate (kontinuierlich)</span>
                            <span class="slider-value" id="vaccineValue">0%</span>
                        </div>
                        <input type="range" id="vaccinationRate" min="0" max="50" value="0">
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn primary" id="playBtn" onclick="togglePlay()">‚ñ∂ Starten</button>
                    <button class="btn secondary" onclick="resetSimulation()">‚Ü∫ Reset</button>
                </div>

                <div class="btn-row">
                    <button class="btn vaccine" onclick="vaccinatePopulation()">üíâ Impfen (+10)</button>
                    <button class="btn quarantine" onclick="toggleQuarantine()">üîí Quarant√§ne</button>
                </div>

                <div class="graph-container">
                    <div class="graph-title">üìà Epidemieverlauf</div>
                    <canvas id="graphCanvas"></canvas>
                </div>

                <div class="scenario-section">
                    <div class="panel-title">üé¨ Szenarien</div>
                    <div class="scenario-grid">
                        <button class="scenario-btn" onclick="loadScenario('flu')">Grippe</button>
                        <button class="scenario-btn" onclick="loadScenario('measles')">Masern</button>
                        <button class="scenario-btn" onclick="loadScenario('covid')">COVID</button>
                        <button class="scenario-btn" onclick="loadScenario('ebola')">Ebola</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const gctx = graphCanvas.getContext('2d');

        const POPULATION = 150;
        const RADIUS = 5;
        const INFECTION_RADIUS = 18;

        let isPlaying = false;
        let day = 0;
        let frameCount = 0;
        const framesPerDay = 25;

        let infectionRate = 50;
        let recoveryDays = 14;
        let mortalityRate = 2;
        let socialDistance = 0;
        let vaccinationRate = 0;
        let quarantineMode = false;

        let people = [];
        let history = { healthy: [], infected: [], recovered: [], vaccinated: [], dead: [] };
        let peakInfected = 0;
        let peakDay = 0;
        let totalInfections = 0;

        class Person {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 3;
                this.vy = (Math.random() - 0.5) * 3;
                this.status = 'healthy';
                this.infectionDay = 0;
                this.quarantined = false;
                this.infectionsCount = 0;
            }

            update() {
                if (this.status === 'dead' || this.quarantined) return;

                const speedFactor = 1 - (socialDistance / 100) * 0.9;

                this.x += this.vx * speedFactor;
                this.y += this.vy * speedFactor;

                // Bounce off walls
                if (this.x < RADIUS || this.x > canvas.width - RADIUS) {
                    this.vx *= -1;
                    this.x = Math.max(RADIUS, Math.min(canvas.width - RADIUS, this.x));
                }
                if (this.y < RADIUS || this.y > canvas.height - RADIUS) {
                    this.vy *= -1;
                    this.y = Math.max(RADIUS, Math.min(canvas.height - RADIUS, this.y));
                }

                // Random movement changes
                if (Math.random() < 0.03) {
                    this.vx += (Math.random() - 0.5) * 0.8;
                    this.vy += (Math.random() - 0.5) * 0.8;
                    const maxSpeed = 2.5;
                    const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    if (speed > maxSpeed) {
                        this.vx = (this.vx / speed) * maxSpeed;
                        this.vy = (this.vy / speed) * maxSpeed;
                    }
                }
            }

            draw() {
                const colors = {
                    healthy: '#2ecc71',
                    infected: '#e74c3c',
                    recovered: '#3498db',
                    vaccinated: '#9b59b6',
                    dead: '#7f8c8d'
                };

                // Glow for infected
                if (this.status === 'infected' && !this.quarantined) {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, INFECTION_RADIUS, 0, Math.PI * 2);
                    const grad = ctx.createRadialGradient(this.x, this.y, RADIUS, this.x, this.y, INFECTION_RADIUS);
                    grad.addColorStop(0, 'rgba(231, 76, 60, 0.3)');
                    grad.addColorStop(1, 'rgba(231, 76, 60, 0)');
                    ctx.fillStyle = grad;
                    ctx.fill();
                }

                // Main circle
                ctx.beginPath();
                ctx.arc(this.x, this.y, RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = colors[this.status];
                ctx.fill();

                // Shine effect
                ctx.beginPath();
                ctx.arc(this.x - 1.5, this.y - 1.5, RADIUS * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.fill();

                // Quarantine indicator
                if (this.quarantined) {
                    ctx.strokeStyle = '#f39c12';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, RADIUS + 4, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // Dead X marker
                if (this.status === 'dead') {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(this.x - 3, this.y - 3);
                    ctx.lineTo(this.x + 3, this.y + 3);
                    ctx.moveTo(this.x + 3, this.y - 3);
                    ctx.lineTo(this.x - 3, this.y + 3);
                    ctx.stroke();
                }
            }
        }

        function initSimulation() {
            people = [];
            for (let i = 0; i < POPULATION; i++) {
                people.push(new Person(
                    RADIUS + Math.random() * (canvas.width - RADIUS * 2),
                    RADIUS + Math.random() * (canvas.height - RADIUS * 2)
                ));
            }
            // Patient zero
            people[0].status = 'infected';
            people[0].infectionDay = 0;
            totalInfections = 1;

            history = { healthy: [], infected: [], recovered: [], vaccinated: [], dead: [] };
            day = 0;
            frameCount = 0;
            peakInfected = 1;
            peakDay = 0;
        }

        function checkInfections() {
            const infected = people.filter(p => p.status === 'infected' && !p.quarantined);
            const susceptible = people.filter(p => p.status === 'healthy');

            infected.forEach(inf => {
                susceptible.forEach(sus => {
                    const dx = inf.x - sus.x;
                    const dy = inf.y - sus.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < INFECTION_RADIUS) {
                        const effectiveRate = infectionRate * (1 - socialDistance / 200);
                        if (Math.random() * 100 < effectiveRate / 15) {
                            sus.status = 'infected';
                            sus.infectionDay = day;
                            inf.infectionsCount++;
                            totalInfections++;
                        }
                    }
                });
            });
        }

        function checkRecoveryAndDeath() {
            people.forEach(p => {
                if (p.status === 'infected' && day - p.infectionDay >= recoveryDays) {
                    if (Math.random() * 100 < mortalityRate) {
                        p.status = 'dead';
                    } else {
                        p.status = 'recovered';
                    }
                    p.quarantined = false;
                }
            });
        }

        function applyVaccination() {
            if (vaccinationRate > 0 && Math.random() < vaccinationRate / 500) {
                const healthy = people.filter(p => p.status === 'healthy');
                if (healthy.length > 0) {
                    const target = healthy[Math.floor(Math.random() * healthy.length)];
                    target.status = 'vaccinated';
                }
            }
        }

        function calculateR() {
            const recentInfectors = people.filter(p =>
                (p.status === 'recovered' || p.status === 'dead') &&
                day - p.infectionDay <= recoveryDays + 5
            );
            if (recentInfectors.length === 0) return 0;
            const total = recentInfectors.reduce((sum, p) => sum + p.infectionsCount, 0);
            return (total / recentInfectors.length).toFixed(2);
        }

        function updateStats() {
            const stats = {
                healthy: people.filter(p => p.status === 'healthy').length,
                infected: people.filter(p => p.status === 'infected').length,
                recovered: people.filter(p => p.status === 'recovered').length,
                vaccinated: people.filter(p => p.status === 'vaccinated').length,
                dead: people.filter(p => p.status === 'dead').length
            };

            document.getElementById('healthyCount').textContent = stats.healthy;
            document.getElementById('infectedCount').textContent = stats.infected;
            document.getElementById('recoveredCount').textContent = stats.recovered;
            document.getElementById('vaccinatedCount').textContent = stats.vaccinated;
            document.getElementById('dayCount').textContent = day;
            document.getElementById('activeCases').textContent = stats.infected;

            // Track peak
            if (stats.infected > peakInfected) {
                peakInfected = stats.infected;
                peakDay = day;
            }
            document.getElementById('peakCases').textContent = peakInfected;
            document.getElementById('peakCases').nextElementSibling.textContent = `Tag ${peakDay}`;

            // R-value
            const r = calculateR();
            const rEl = document.getElementById('rValue');
            const rInd = document.getElementById('rIndicator');
            rEl.textContent = r > 0 ? r : (stats.infected > 0 ? '~2.5' : '0');

            if (r >= 1.5 || (stats.infected > 5 && r == 0)) {
                rEl.className = 'r-value high';
                rInd.className = 'r-indicator spreading';
                rInd.textContent = 'Ausbreitung';
            } else if (r >= 1) {
                rEl.className = 'r-value medium';
                rInd.className = 'r-indicator stable';
                rInd.textContent = 'Stabil';
            } else {
                rEl.className = 'r-value low';
                rInd.className = 'r-indicator declining';
                rInd.textContent = 'R√ºckgang';
            }

            // Herd immunity
            const immune = stats.recovered + stats.vaccinated;
            const immunityPct = (immune / POPULATION * 100).toFixed(0);
            document.getElementById('immunityPercent').textContent = immunityPct + '%';
            document.getElementById('herdProgress').style.width = immunityPct + '%';

            return stats;
        }

        function drawGraph() {
            gctx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (history.infected.length < 2) return;

            const h = graphCanvas.height;
            const w = graphCanvas.width;
            const maxLen = 120;

            const drawLine = (data, color, fill = false) => {
                gctx.strokeStyle = color;
                gctx.lineWidth = 2;
                gctx.beginPath();

                const startIdx = Math.max(0, data.length - maxLen);
                for (let i = startIdx; i < data.length; i++) {
                    const x = ((i - startIdx) / maxLen) * w;
                    const y = h - (data[i] / POPULATION) * h;
                    if (i === startIdx) gctx.moveTo(x, y);
                    else gctx.lineTo(x, y);
                }
                gctx.stroke();

                if (fill) {
                    gctx.lineTo(w, h);
                    gctx.lineTo(0, h);
                    gctx.closePath();
                    gctx.fillStyle = color.replace(')', ', 0.1)').replace('rgb', 'rgba');
                    gctx.fill();
                }
            };

            drawLine(history.infected, 'rgb(231, 76, 60)', true);
            drawLine(history.recovered, 'rgb(52, 152, 219)');
            drawLine(history.vaccinated, 'rgb(155, 89, 182)');
        }

        function animate() {
            if (!isPlaying) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Update
            people.forEach(p => p.update());
            checkInfections();
            applyVaccination();

            frameCount++;
            if (frameCount >= framesPerDay) {
                frameCount = 0;
                day++;
                checkRecoveryAndDeath();

                const stats = updateStats();
                history.healthy.push(stats.healthy);
                history.infected.push(stats.infected);
                history.recovered.push(stats.recovered);
                history.vaccinated.push(stats.vaccinated);
                history.dead.push(stats.dead);

                drawGraph();

                if (stats.infected === 0 && day > 1) {
                    isPlaying = false;
                    document.getElementById('playBtn').textContent = '‚úì Ende';
                }
            } else {
                updateStats();
            }

            // Draw
            people.forEach(p => p.draw());

            requestAnimationFrame(animate);
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? '‚è∏ Pause' : '‚ñ∂ Starten';
            if (isPlaying) animate();
        }

        function resetSimulation() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂ Starten';
            initSimulation();
            updateStats();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            people.forEach(p => p.draw());
            gctx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
        }

        function vaccinatePopulation() {
            const healthy = people.filter(p => p.status === 'healthy');
            const toVaccinate = Math.min(10, healthy.length);
            for (let i = 0; i < toVaccinate; i++) {
                if (healthy[i]) healthy[i].status = 'vaccinated';
            }
            updateStats();
            people.forEach(p => p.draw());
        }

        function toggleQuarantine() {
            quarantineMode = !quarantineMode;
            people.forEach(p => {
                if (p.status === 'infected') {
                    p.quarantined = quarantineMode;
                }
            });
        }

        function loadScenario(scenario) {
            resetSimulation();
            const scenarios = {
                flu: { infection: 30, recovery: 7, mortality: 0.1, name: 'Grippe' },
                measles: { infection: 95, recovery: 10, mortality: 0.2, name: 'Masern' },
                covid: { infection: 50, recovery: 14, mortality: 2, name: 'COVID-19' },
                ebola: { infection: 40, recovery: 21, mortality: 50, name: 'Ebola' }
            };
            const s = scenarios[scenario];
            infectionRate = s.infection;
            recoveryDays = s.recovery;
            mortalityRate = s.mortality;

            document.getElementById('infectionRate').value = s.infection;
            document.getElementById('recoveryTime').value = s.recovery;
            document.getElementById('mortalityRate').value = s.mortality;
            document.getElementById('infectionValue').textContent = s.infection + '%';
            document.getElementById('recoveryValue').textContent = s.recovery + 'd';
            document.getElementById('mortalityValue').textContent = s.mortality + '%';
        }

        // Event Listeners
        document.getElementById('infectionRate').addEventListener('input', (e) => {
            infectionRate = parseInt(e.target.value);
            document.getElementById('infectionValue').textContent = infectionRate + '%';
        });

        document.getElementById('recoveryTime').addEventListener('input', (e) => {
            recoveryDays = parseInt(e.target.value);
            document.getElementById('recoveryValue').textContent = recoveryDays + 'd';
        });

        document.getElementById('mortalityRate').addEventListener('input', (e) => {
            mortalityRate = parseInt(e.target.value);
            document.getElementById('mortalityValue').textContent = mortalityRate + '%';
        });

        document.getElementById('socialDistance').addEventListener('input', (e) => {
            socialDistance = parseInt(e.target.value);
            document.getElementById('distanceValue').textContent = socialDistance + '%';
        });

        document.getElementById('vaccinationRate').addEventListener('input', (e) => {
            vaccinationRate = parseInt(e.target.value);
            document.getElementById('vaccineValue').textContent = vaccinationRate + '%';
        });

        // Initialize with responsive sizing
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            people.forEach(p => p.draw());
        }

        graphCanvas.width = graphCanvas.offsetWidth;
        graphCanvas.height = 60;
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        initSimulation();
        updateStats();
        people.forEach(p => p.draw());
    </script>
</body>
</html>
