<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blutkreislauf - WebGL Partikel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #0a0a1a;
            overflow: hidden;
            color: #fff;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        .ui-overlay {
            position: fixed;
            pointer-events: none;
            z-index: 100;
        }

        .ui-overlay > * {
            pointer-events: auto;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 25px 30px;
            background: linear-gradient(180deg, rgba(10,10,26,0.95) 0%, transparent 100%);
            z-index: 100;
        }

        h1 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .control-panel {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 280px;
            background: rgba(10, 10, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 107, 107, 0.2);
            padding: 25px;
            z-index: 100;
        }

        .panel-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.9em;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #ff6b6b;
        }

        .stat-value.blue { color: #5b8def; }
        .stat-value.green { color: #4ade80; }

        .slider-control {
            margin-top: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .slider-value {
            color: #ff6b6b;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #3b82f6, #ff6b6b);
            border-radius: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .legend {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.85em;
            color: rgba(255,255,255,0.7);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 15px currentColor;
        }

        .info-box {
            position: fixed;
            bottom: 30px;
            left: 30px;
            right: 340px;
            background: rgba(10, 10, 30, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 107, 107, 0.15);
            padding: 20px 25px;
            z-index: 100;
        }

        .info-box h3 {
            color: #ff8e8e;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .info-box p {
            color: rgba(255,255,255,0.6);
            font-size: 0.85em;
            line-height: 1.6;
        }

        @media (max-width: 800px) {
            .control-panel { display: none; }
            .info-box { right: 30px; }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="header">
        <h1>‚ù§Ô∏è Blutkreislauf</h1>
        <p class="subtitle">10.000+ Partikel simulieren den Blutfluss in Echtzeit</p>
    </div>

    <div class="control-panel">
        <div class="panel-title">üíì Vitalzeichen</div>

        <div class="stat-row">
            <span class="stat-label">Herzfrequenz</span>
            <span class="stat-value" id="bpmValue">72</span>
        </div>

        <div class="stat-row">
            <span class="stat-label">O‚ÇÇ-S√§ttigung</span>
            <span class="stat-value blue" id="o2Value">98%</span>
        </div>

        <div class="stat-row">
            <span class="stat-label">Partikel</span>
            <span class="stat-value green" id="particleCount">10,000</span>
        </div>

        <div class="slider-control">
            <div class="slider-label">
                <span>Herzfrequenz</span>
                <span class="slider-value" id="sliderValue">72 BPM</span>
            </div>
            <input type="range" id="heartRate" min="40" max="180" value="72">
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff6b6b; color: #ff6b6b;"></div>
                <span>Sauerstoffreich (Arterien)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #5b8def; color: #5b8def;"></div>
                <span>Sauerstoffarm (Venen)</span>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h3>üìö Echtzeit-Partikelsimulation</h3>
        <p>Diese Simulation verwendet <strong>WebGL</strong> um tausende Blutpartikel gleichzeitig zu berechnen und darzustellen. Jedes Partikel folgt dem Kreislauf und wechselt seine Farbe beim Gasaustausch in Lunge und K√∂rpergewebe.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');

        if (!gl) {
            alert('WebGL wird nicht unterst√ºtzt');
        }

        // Configuration
        const PARTICLE_COUNT = 10000;
        let heartRate = 72;
        let time = 0;

        // Resize canvas
        function resize() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        resize();
        window.addEventListener('resize', resize);

        // Vertex Shader
        const vertexShaderSource = `
            attribute vec2 a_position;
            attribute float a_progress;
            attribute float a_pathType;
            attribute float a_size;

            uniform float u_time;
            uniform float u_heartRate;
            uniform vec2 u_resolution;

            varying float v_oxygenated;
            varying float v_glow;

            // Path functions
            vec2 getBodyPath(float t) {
                float angle = t * 6.28318;

                // Heart position
                vec2 heart = vec2(0.5, 0.45);

                // Figure-8 path through body
                float x = heart.x + sin(angle) * 0.25;
                float y = heart.y + sin(angle * 2.0) * 0.2;

                // Add some turbulence
                x += sin(t * 20.0 + u_time) * 0.01;
                y += cos(t * 15.0 + u_time * 1.3) * 0.01;

                return vec2(x, y);
            }

            vec2 getLungPath(float t) {
                float angle = t * 6.28318;

                // Smaller circle for lung circulation
                vec2 heart = vec2(0.5, 0.45);
                float x = heart.x + 0.12 + cos(angle) * 0.15;
                float y = heart.y - 0.1 + sin(angle) * 0.12;

                x += sin(t * 25.0 + u_time) * 0.008;
                y += cos(t * 20.0 + u_time) * 0.008;

                return vec2(x, y);
            }

            void main() {
                float speed = u_heartRate / 72.0;
                float progress = fract(a_progress + u_time * 0.1 * speed);

                vec2 pos;
                if (a_pathType < 0.5) {
                    pos = getBodyPath(progress);
                    // Oxygenated when leaving heart (0-0.5), deoxygenated returning (0.5-1)
                    v_oxygenated = progress < 0.5 ? 1.0 : 0.0;
                } else {
                    pos = getLungPath(progress);
                    // Opposite for lung: deoxygenated going in, oxygenated coming out
                    v_oxygenated = progress > 0.5 ? 1.0 : 0.0;
                }

                // Heartbeat pulse effect
                float heartbeat = sin(u_time * u_heartRate / 10.0) * 0.5 + 0.5;
                v_glow = 0.5 + heartbeat * 0.5;

                // Convert to clip space
                vec2 clipPos = (pos * 2.0 - 1.0);
                clipPos.x *= u_resolution.y / u_resolution.x;

                gl_Position = vec4(clipPos, 0.0, 1.0);
                gl_PointSize = a_size * (0.8 + heartbeat * 0.4);
            }
        `;

        // Fragment Shader
        const fragmentShaderSource = `
            precision mediump float;

            varying float v_oxygenated;
            varying float v_glow;

            void main() {
                // Circular point
                vec2 coord = gl_PointCoord - vec2(0.5);
                float dist = length(coord);

                if (dist > 0.5) discard;

                // Soft glow
                float alpha = smoothstep(0.5, 0.0, dist);
                alpha *= v_glow;

                // Color based on oxygenation
                vec3 oxyColor = vec3(1.0, 0.42, 0.42); // Red
                vec3 deoxyColor = vec3(0.36, 0.55, 0.94); // Blue

                vec3 color = mix(deoxyColor, oxyColor, v_oxygenated);

                // Add glow
                color += 0.3 * alpha;

                gl_FragColor = vec4(color, alpha * 0.8);
            }
        `;

        // Compile shader
        function createShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        // Create program
        const vertexShader = createShader(gl.VERTEX_SHADER, vertexShaderSource);
        const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentShaderSource);

        const program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);

        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
            console.error(gl.getProgramInfoLog(program));
        }

        gl.useProgram(program);

        // Create particle data
        const positions = new Float32Array(PARTICLE_COUNT * 2);
        const progress = new Float32Array(PARTICLE_COUNT);
        const pathType = new Float32Array(PARTICLE_COUNT);
        const sizes = new Float32Array(PARTICLE_COUNT);

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            positions[i * 2] = Math.random();
            positions[i * 2 + 1] = Math.random();
            progress[i] = Math.random();
            pathType[i] = Math.random() < 0.7 ? 0.0 : 1.0; // 70% body, 30% lung
            sizes[i] = 3 + Math.random() * 4;
        }

        // Create buffers
        function createBuffer(data, attribute) {
            const buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);

            const loc = gl.getAttribLocation(program, attribute);
            const size = attribute === 'a_position' ? 2 : 1;
            gl.enableVertexAttribArray(loc);
            gl.vertexAttribPointer(loc, size, gl.FLOAT, false, 0, 0);
        }

        createBuffer(positions, 'a_position');
        createBuffer(progress, 'a_progress');
        createBuffer(pathType, 'a_pathType');
        createBuffer(sizes, 'a_size');

        // Uniforms
        const u_time = gl.getUniformLocation(program, 'u_time');
        const u_heartRate = gl.getUniformLocation(program, 'u_heartRate');
        const u_resolution = gl.getUniformLocation(program, 'u_resolution');

        // Enable blending
        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

        // Draw organs (2D canvas overlay approach - simpler for demo)
        function drawBackground() {
            // Dark gradient background
            gl.clearColor(0.04, 0.04, 0.1, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
        }

        // Animation loop
        function animate() {
            time += 0.016;

            drawBackground();

            gl.uniform1f(u_time, time);
            gl.uniform1f(u_heartRate, heartRate);
            gl.uniform2f(u_resolution, canvas.width, canvas.height);

            gl.drawArrays(gl.POINTS, 0, PARTICLE_COUNT);

            requestAnimationFrame(animate);
        }

        // UI Controls
        document.getElementById('heartRate').addEventListener('input', (e) => {
            heartRate = parseInt(e.target.value);
            document.getElementById('bpmValue').textContent = heartRate;
            document.getElementById('sliderValue').textContent = heartRate + ' BPM';

            let o2 = heartRate < 60 ? 95 : heartRate > 150 ? 92 : 98;
            document.getElementById('o2Value').textContent = o2 + '%';
        });

        // Start
        document.getElementById('particleCount').textContent = PARTICLE_COUNT.toLocaleString();
        animate();
    </script>
</body>
</html>
