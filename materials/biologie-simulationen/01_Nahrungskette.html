<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nahrungsketten-Builder</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2f4a 50%, #0d1f35 100%);
            min-height: 100vh;
            padding: 8px;
            color: #fff;
        }

        .container { max-width: 100%; margin: 0 auto; height: 100vh; }

        header {
            text-align: center;
            margin-bottom: 8px;
        }

        h1 {
            font-size: 1.4em;
            font-weight: 700;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
        }

        .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 0.75em;
        }

        /* Difficulty selector */
        .difficulty-bar {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 4px 0;
        }

        .diff-btn {
            padding: 4px 12px;
            border: 2px solid rgba(74, 222, 128, 0.3);
            background: rgba(74, 222, 128, 0.1);
            color: rgba(255,255,255,0.7);
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.7em;
            transition: all 0.3s;
        }

        .diff-btn:hover {
            background: rgba(74, 222, 128, 0.2);
        }

        .diff-btn.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border-color: transparent;
            color: #0a1628;
            font-weight: 600;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.6em;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 12px;
            height: calc(100vh - 110px);
            min-height: 400px;
        }

        /* Main simulation area */
        .simulation-area {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; height: auto; }
            .simulation-area { overflow-y: visible; }
        }

        /* Chain display */
        .chain-container {
            position: relative;
            background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
            border-radius: 15px;
            padding: 15px 10px;
            margin-bottom: 8px;
            min-height: 140px;
            overflow: hidden;
        }

        /* Sun animation */
        .sun-source {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
        }

        .sun-emoji {
            font-size: 2em;
            animation: pulse-sun 2s ease-in-out infinite;
        }

        @keyframes pulse-sun {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .sun-rays {
            position: absolute;
            width: 80px;
            height: 80px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(251,191,36,0.3) 0%, transparent 70%);
            animation: rays 3s linear infinite;
            pointer-events: none;
        }

        @keyframes rays {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .chain-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-left: 60px;
        }

        .chain-empty {
            color: rgba(255,255,255,0.4);
            text-align: center;
            padding: 15px;
            font-size: 0.85em;
        }

        .chain-item {
            text-align: center;
            padding: 8px 10px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            min-width: 75px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .chain-item.valid { border-color: rgba(74, 222, 128, 0.5); box-shadow: 0 0 15px rgba(74, 222, 128, 0.2); }
        .chain-item.invalid { border-color: rgba(239, 68, 68, 0.5); box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); animation: shake 0.5s; }
        .chain-item.warning { border-color: rgba(251, 191, 36, 0.5); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .chain-item:hover { transform: translateY(-3px); }
        .chain-item .emoji { font-size: 1.8em; }
        .chain-item .name { margin-top: 2px; font-weight: 600; font-size: 0.7em; }
        .chain-item .role { font-size: 0.6em; color: rgba(255,255,255,0.5); }

        .chain-item .energy-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a1a2e;
            font-size: 0.65em;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 10px;
        }

        .chain-item .remove {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 22px;
            height: 22px;
            background: #ef4444;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chain-item:hover .remove { opacity: 1; }

        .arrow {
            font-size: 1.5em;
            color: #4ade80;
            position: relative;
        }

        .arrow::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: linear-gradient(90deg, #4ade80, transparent);
            left: 100%;
            top: 50%;
            animation: energy-flow 1s linear infinite;
        }

        @keyframes energy-flow {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(10px); }
        }

        /* Energy visualization */
        .energy-section {
            background: rgba(251, 191, 36, 0.1);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 6px;
        }

        .energy-title {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.8em;
            color: #fbbf24;
        }

        .energy-bar-container {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .energy-segment {
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            font-weight: 600;
            color: rgba(0,0,0,0.7);
            transition: all 0.5s;
        }

        .energy-loss {
            text-align: center;
            margin-top: 4px;
            font-size: 0.7em;
            color: rgba(255,255,255,0.6);
        }

        /* Hint box */
        .hint-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .hint-icon {
            font-size: 1em;
            flex-shrink: 0;
        }

        .hint-text {
            font-size: 0.75em;
            color: rgba(255,255,255,0.8);
        }

        /* Feedback */
        .feedback {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.8em;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback.correct {
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid #4ade80;
            display: block;
        }

        .feedback.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid #ef4444;
            display: block;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .control-btn {
            padding: 6px 14px;
            font-size: 0.75em;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .control-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .control-btn.check { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1628; }
        .control-btn.reset { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .control-btn.hint { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }

        /* Organism palette - hidden in compact view */
        .category-section {
            display: none;
        }

        .category-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.75em;
            margin-bottom: 4px;
        }

        .category-label.producer { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .category-label.consumer1 { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .category-label.consumer2 { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .category-label.decomposer { background: rgba(168, 85, 247, 0.15); color: #c084fc; }

        .category-count {
            margin-left: auto;
            font-size: 0.65em;
            opacity: 0.7;
        }

        .organism-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }

        .palette-item {
            text-align: center;
            padding: 6px 3px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .palette-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        .palette-item.used {
            opacity: 0.4;
            pointer-events: none;
        }

        .palette-item.producer:hover { border-color: rgba(34, 197, 94, 0.5); }
        .palette-item.consumer1:hover { border-color: rgba(59, 130, 246, 0.5); }
        .palette-item.consumer2:hover { border-color: rgba(239, 68, 68, 0.5); }
        .palette-item.decomposer:hover { border-color: rgba(168, 85, 247, 0.5); }

        .palette-item .emoji { font-size: 1.4em; }
        .palette-item .name { font-size: 0.6em; margin-top: 1px; color: rgba(255,255,255,0.7); }

        /* Right panel styles */
        .right-panel {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .panel-category {
            display: none;
        }

        .panel-category.active {
            display: block;
        }

        /* Quiz modal */
        .quiz-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .quiz-overlay.active { display: flex; }

        .quiz-box {
            background: linear-gradient(135deg, #1a2f4a, #0d1f35);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .quiz-title {
            font-size: 1.5em;
            color: #4ade80;
            margin-bottom: 20px;
        }

        .quiz-question {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 12px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 1em;
            color: white;
        }

        .quiz-option:hover { background: rgba(255,255,255,0.1); border-color: rgba(74, 222, 128, 0.5); }
        .quiz-option.correct { background: rgba(74, 222, 128, 0.2); border-color: #4ade80; }
        .quiz-option.wrong { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }

        .quiz-close {
            padding: 10px 30px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            border-radius: 20px;
            color: #0a1628;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        /* Info box - hidden */
        .info-box {
            display: none;
        }

        @media (max-width: 900px) {
            .sun-source { display: none; }
            .chain-display { margin-left: 0; }
            .right-panel { grid-column: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîó Nahrungsketten-Builder</h1>
            <p class="subtitle">Baue eine Nahrungskette und verstehe den Energiefluss</p>
        </header>

        <div class="difficulty-bar">
            <button class="diff-btn active" onclick="setDifficulty('easy')">üå± Einfach</button>
            <button class="diff-btn" onclick="setDifficulty('medium')">üåø Mittel</button>
            <button class="diff-btn" onclick="setDifficulty('hard')">üå≥ Schwer</button>
        </div>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="scoreValue">0</div>
                <div class="stat-label">Punkte</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="streakValue">0</div>
                <div class="stat-label">Serie</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="chainLenValue">0/3</div>
                <div class="stat-label">Kettenl√§nge</div>
            </div>
        </div>

        <div class="main-layout">
            <div class="simulation-area">
            <div class="chain-container">
                <div class="sun-source">
                    <div class="sun-rays"></div>
                    <div class="sun-emoji">‚òÄÔ∏è</div>
                    <div style="font-size: 0.7em; color: rgba(255,255,255,0.5); margin-top: 5px;">Energie</div>
                </div>
                <div class="chain-display" id="chainDisplay">
                    <div class="chain-empty">Klicke auf Organismen, um deine Nahrungskette zu bauen...</div>
                </div>
            </div>

            <div class="energy-section">
                <div class="energy-title">
                    <span>‚ö°</span>
                    <span>Energiefluss</span>
                </div>
                <div class="energy-bar-container" id="energyBar">
                    <div class="energy-segment" style="flex: 10; background: #fbbf24;">100%</div>
                </div>
                <div class="energy-loss" id="energyLoss">
                    Bei jedem Schritt gehen ca. 90% der Energie als W√§rme verloren!
                </div>
            </div>

            <div class="hint-box" id="hintBox">
                <span class="hint-icon">üí°</span>
                <span class="hint-text" id="hintText">Tipp: Beginne mit einem Produzenten (gr√ºne Pflanzen), der Sonnenenergie umwandelt!</span>
            </div>

            <div class="feedback" id="feedback"></div>

            <div class="controls">
                <button class="control-btn hint" onclick="showHint()">üí° Tipp</button>
                <button class="control-btn check" onclick="checkChain()">‚úì √úberpr√ºfen</button>
                <button class="control-btn reset" onclick="resetChain()">‚Ü∫ Neu</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-category active">
                <div class="category-label producer" style="display: flex; margin-bottom: 4px;">
                    <span>üå± Produzenten</span>
                </div>
                <div class="organism-palette" id="producers"></div>
            </div>

            <div class="panel-category active">
                <div class="category-label consumer1" style="display: flex; margin-bottom: 4px; margin-top: 4px;">
                    <span>üê∞ Konsumenten 1</span>
                </div>
                <div class="organism-palette" id="consumers1"></div>
            </div>

            <div class="panel-category active">
                <div class="category-label consumer2" style="display: flex; margin-bottom: 4px; margin-top: 4px;">
                    <span>ü¶ä Konsumenten 2+</span>
                </div>
                <div class="organism-palette" id="consumers2"></div>
            </div>

            <div class="panel-category active">
                <div class="category-label decomposer" style="display: flex; margin-bottom: 4px; margin-top: 4px;">
                    <span>üçÑ Destruenten</span>
                </div>
                <div class="organism-palette" id="decomposers"></div>
            </div>
        </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="quiz-overlay" id="quizOverlay">
        <div class="quiz-box">
            <div class="quiz-title">üéì Bonusfrage!</div>
            <div class="quiz-question" id="quizQuestion"></div>
            <div class="quiz-options" id="quizOptions"></div>
            <button class="quiz-close" onclick="closeQuiz()" style="display: none;" id="quizClose">Weiter</button>
        </div>
    </div>

    <script>
        const organisms = {
            producers: [
                { emoji: 'üåø', name: 'Gras', role: 'Produzent', energy: 100 },
                { emoji: 'üåª', name: 'Sonnenblume', role: 'Produzent', energy: 100 },
                { emoji: 'üå≥', name: 'Eiche', role: 'Produzent', energy: 100 },
                { emoji: 'üåæ', name: 'Weizen', role: 'Produzent', energy: 100 },
                { emoji: 'ü•¨', name: 'Salat', role: 'Produzent', energy: 100 },
                { emoji: 'üåµ', name: 'Kaktus', role: 'Produzent', energy: 100 }
            ],
            consumers1: [
                { emoji: 'üê∞', name: 'Hase', role: 'Konsument 1', energy: 10 },
                { emoji: 'üê≠', name: 'Maus', role: 'Konsument 1', energy: 10 },
                { emoji: 'ü¶ó', name: 'Grille', role: 'Konsument 1', energy: 10 },
                { emoji: 'üêõ', name: 'Raupe', role: 'Konsument 1', energy: 10 },
                { emoji: 'üêøÔ∏è', name: 'Eichh√∂rnchen', role: 'Konsument 1', energy: 10 },
                { emoji: 'ü¶å', name: 'Reh', role: 'Konsument 1', energy: 10 }
            ],
            consumers2: [
                { emoji: 'ü¶ä', name: 'Fuchs', role: 'Konsument 2', energy: 1 },
                { emoji: 'ü¶Ö', name: 'Adler', role: 'Konsument 2', energy: 1 },
                { emoji: 'üêç', name: 'Schlange', role: 'Konsument 2', energy: 1 },
                { emoji: 'ü¶â', name: 'Eule', role: 'Konsument 2', energy: 1 },
                { emoji: 'üê∫', name: 'Wolf', role: 'Konsument 3', energy: 0.1 },
                { emoji: 'ü¶Å', name: 'L√∂we', role: 'Konsument 3', energy: 0.1 }
            ],
            decomposers: [
                { emoji: 'üçÑ', name: 'Pilz', role: 'Destruent', energy: 0 },
                { emoji: 'ü¶†', name: 'Bakterien', role: 'Destruent', energy: 0 },
                { emoji: 'ü™±', name: 'Regenwurm', role: 'Destruent', energy: 0 }
            ]
        };

        const quizQuestions = [
            {
                q: "Warum geht bei jedem Schritt der Nahrungskette Energie verloren?",
                options: ["Tiere sind faul", "Energie wird f√ºr Bewegung und W√§rme verbraucht", "Die Sonne scheint nicht genug", "Pflanzen speichern alles"],
                correct: 1
            },
            {
                q: "Was passiert, wenn alle Produzenten verschwinden?",
                options: ["Nichts besonderes", "Die Fleischfresser √ºbernehmen", "Das gesamte √ñkosystem bricht zusammen", "Die Tiere fressen Steine"],
                correct: 2
            },
            {
                q: "Warum gibt es weniger Fleischfresser als Pflanzenfresser?",
                options: ["Fleischfresser sind seltener geboren", "Es gibt nicht genug Energie f√ºr viele Fleischfresser", "Pflanzenfresser sind st√§rker", "Zufall"],
                correct: 1
            },
            {
                q: "Welche Rolle spielen Destruenten?",
                options: ["Sie jagen andere Tiere", "Sie zersetzen tote Organismen und recyceln N√§hrstoffe", "Sie produzieren Sauerstoff", "Sie sind unwichtig"],
                correct: 1
            }
        ];

        let chain = [];
        let score = 0;
        let streak = 0;
        let difficulty = 'easy';
        let minChainLength = 3;
        let maxChainLength = 4;

        const hints = {
            empty: "Tipp: Beginne mit einem Produzenten (gr√ºne Pflanzen), der Sonnenenergie umwandelt!",
            afterProducer: "Gut! Jetzt f√ºge einen Pflanzenfresser (Konsument 1. Ordnung) hinzu.",
            afterConsumer1: "Super! Du kannst jetzt einen Fleischfresser oder einen Destruenten hinzuf√ºgen.",
            afterConsumer2: "Klasse! Du kannst noch einen gr√∂√üeren Fleischfresser oder einen Destruenten hinzuf√ºgen.",
            canCheck: "Deine Kette sieht gut aus! Klicke auf '√úberpr√ºfen' um sie zu testen.",
            wrongStart: "Achtung: Eine Nahrungskette muss mit einem Produzenten beginnen!",
            wrongOrder: "Hmm, diese Reihenfolge ist nicht nat√ºrlich. Denke an: Wer frisst wen?"
        };

        function setDifficulty(diff) {
            difficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            switch(diff) {
                case 'easy':
                    minChainLength = 3;
                    maxChainLength = 4;
                    break;
                case 'medium':
                    minChainLength = 4;
                    maxChainLength = 5;
                    break;
                case 'hard':
                    minChainLength = 5;
                    maxChainLength = 6;
                    break;
            }

            resetChain();
            updateChainLengthDisplay();
        }

        function updateChainLengthDisplay() {
            document.getElementById('chainLenValue').textContent = `${chain.length}/${minChainLength}`;
        }

        function initPalettes() {
            ['producers', 'consumers1', 'consumers2', 'decomposers'].forEach(category => {
                const container = document.getElementById(category);
                container.innerHTML = '';
                const className = category === 'producers' ? 'producer' :
                                  category === 'consumers1' ? 'consumer1' :
                                  category === 'consumers2' ? 'consumer2' : 'decomposer';

                organisms[category].forEach((org, idx) => {
                    const div = document.createElement('div');
                    div.className = `palette-item ${className}`;
                    div.id = `${category}-${idx}`;
                    div.innerHTML = `<div class="emoji">${org.emoji}</div><div class="name">${org.name}</div>`;
                    div.onclick = () => addToChain(org, `${category}-${idx}`);
                    container.appendChild(div);
                });
            });
        }

        function addToChain(organism, paletteId) {
            if (chain.length >= maxChainLength) {
                showFeedback(`Maximal ${maxChainLength} Glieder bei dieser Schwierigkeit!`, false);
                return;
            }

            // Validate addition
            const validation = validateAddition(organism);

            chain.push({ ...organism, paletteId });

            // Mark as used
            document.getElementById(paletteId).classList.add('used');

            renderChain(validation);
            updateHint();
            updateEnergyBar();
            updateChainLengthDisplay();
            hideFeedback();
        }

        function validateAddition(organism) {
            if (chain.length === 0) {
                return organism.role === 'Produzent' ? 'valid' : 'invalid';
            }

            const lastRole = chain[chain.length - 1].role;

            if (lastRole === 'Produzent') {
                return organism.role === 'Konsument 1' ? 'valid' :
                       organism.role === 'Destruent' ? 'valid' : 'invalid';
            }

            if (lastRole === 'Konsument 1') {
                return (organism.role === 'Konsument 2' || organism.role === 'Konsument 3' || organism.role === 'Destruent') ? 'valid' : 'invalid';
            }

            if (lastRole === 'Konsument 2') {
                return (organism.role === 'Konsument 3' || organism.role === 'Destruent') ? 'valid' :
                       organism.role === 'Konsument 2' ? 'warning' : 'invalid';
            }

            if (lastRole === 'Konsument 3') {
                return organism.role === 'Destruent' ? 'valid' : 'invalid';
            }

            return 'invalid';
        }

        function removeFromChain(index) {
            const removed = chain.splice(index);
            removed.forEach(org => {
                document.getElementById(org.paletteId).classList.remove('used');
            });
            renderChain();
            updateHint();
            updateEnergyBar();
            updateChainLengthDisplay();
            hideFeedback();
        }

        function renderChain(lastValidation = null) {
            const display = document.getElementById('chainDisplay');

            if (chain.length === 0) {
                display.innerHTML = '<div class="chain-empty">Klicke auf Organismen, um deine Nahrungskette zu bauen...</div>';
                return;
            }

            display.innerHTML = '';
            chain.forEach((org, index) => {
                const item = document.createElement('div');
                const isLast = index === chain.length - 1;
                const validationClass = isLast && lastValidation ? lastValidation : 'valid';

                item.className = `chain-item ${validationClass}`;
                item.innerHTML = `
                    <button class="remove" onclick="removeFromChain(${index})">√ó</button>
                    <div class="emoji">${org.emoji}</div>
                    <div class="name">${org.name}</div>
                    <div class="role">${org.role}</div>
                    <div class="energy-badge">${org.energy}%</div>
                `;
                display.appendChild(item);

                if (index < chain.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'arrow';
                    arrow.textContent = '‚Üí';
                    display.appendChild(arrow);
                }
            });
        }

        function updateHint() {
            const hintText = document.getElementById('hintText');

            if (chain.length === 0) {
                hintText.textContent = hints.empty;
            } else {
                const lastRole = chain[chain.length - 1].role;

                if (chain.length > 0 && chain[0].role !== 'Produzent') {
                    hintText.textContent = hints.wrongStart;
                } else if (lastRole === 'Produzent') {
                    hintText.textContent = hints.afterProducer;
                } else if (lastRole === 'Konsument 1') {
                    hintText.textContent = hints.afterConsumer1;
                } else if (lastRole === 'Konsument 2' || lastRole === 'Konsument 3') {
                    hintText.textContent = hints.afterConsumer2;
                } else if (chain.length >= minChainLength) {
                    hintText.textContent = hints.canCheck;
                }
            }
        }

        function updateEnergyBar() {
            const container = document.getElementById('energyBar');

            if (chain.length === 0) {
                container.innerHTML = '<div class="energy-segment" style="flex: 10; background: #fbbf24;">100%</div>';
                return;
            }

            container.innerHTML = '';
            const colors = ['#fbbf24', '#f59e0b', '#ef4444', '#dc2626', '#991b1b'];

            chain.forEach((org, idx) => {
                const energy = org.energy;
                const segment = document.createElement('div');
                segment.className = 'energy-segment';
                segment.style.flex = Math.max(energy / 10, 0.5);
                segment.style.background = colors[Math.min(idx, colors.length - 1)];
                segment.textContent = energy >= 1 ? `${energy}%` : '<1%';
                container.appendChild(segment);
            });

            const lossText = document.getElementById('energyLoss');
            const totalLoss = 100 - (chain[chain.length - 1]?.energy || 100);
            lossText.textContent = `Gesamter Energieverlust: ${totalLoss.toFixed(1)}% - Diese Energie wird f√ºr Bewegung und K√∂rperw√§rme verbraucht!`;
        }

        function showHint() {
            const hintBox = document.getElementById('hintBox');
            hintBox.style.animation = 'none';
            hintBox.offsetHeight; // Trigger reflow
            hintBox.style.animation = 'fadeIn 0.3s';
        }

        function checkChain() {
            if (chain.length < minChainLength) {
                showFeedback(`‚ùå Bei "${difficulty === 'easy' ? 'Einfach' : difficulty === 'medium' ? 'Mittel' : 'Schwer'}" brauchst du mindestens ${minChainLength} Glieder!`, false);
                streak = 0;
                updateStats();
                return;
            }

            if (chain[0].role !== 'Produzent') {
                showFeedback('‚ùå Eine Nahrungskette muss mit einem Produzenten (Pflanze) beginnen!', false);
                streak = 0;
                updateStats();
                return;
            }

            // Check logical order
            let valid = true;
            for (let i = 1; i < chain.length; i++) {
                const prevRole = chain[i - 1].role;
                const currRole = chain[i].role;

                if (prevRole === 'Produzent' && currRole !== 'Konsument 1' && currRole !== 'Destruent') {
                    valid = false;
                    break;
                }
                if (prevRole === 'Destruent') {
                    valid = false;
                    break;
                }
            }

            if (valid) {
                const points = difficulty === 'easy' ? 10 : difficulty === 'medium' ? 20 : 30;
                score += points * (streak + 1);
                streak++;
                updateStats();

                showFeedback(`‚úÖ Richtig! +${points * streak} Punkte! Die Energie flie√üt von ${chain[0].name} bis ${chain[chain.length - 1].name}.`, true);

                // Show quiz after correct answer
                setTimeout(() => showQuiz(), 1500);
            } else {
                streak = 0;
                updateStats();
                showFeedback('‚ùå Die Reihenfolge stimmt nicht. Denke an: Pflanze ‚Üí Pflanzenfresser ‚Üí Fleischfresser ‚Üí (Destruent)', false);
            }
        }

        function showQuiz() {
            const quiz = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            document.getElementById('quizQuestion').textContent = quiz.q;

            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';

            quiz.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = opt;
                btn.onclick = () => answerQuiz(idx, quiz.correct, btn);
                optionsContainer.appendChild(btn);
            });

            document.getElementById('quizClose').style.display = 'none';
            document.getElementById('quizOverlay').classList.add('active');
        }

        function answerQuiz(selected, correct, btn) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach((opt, idx) => {
                opt.disabled = true;
                if (idx === correct) opt.classList.add('correct');
                if (idx === selected && selected !== correct) opt.classList.add('wrong');
            });

            if (selected === correct) {
                score += 15;
                updateStats();
            }

            document.getElementById('quizClose').style.display = 'inline-block';
        }

        function closeQuiz() {
            document.getElementById('quizOverlay').classList.remove('active');
        }

        function updateStats() {
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('streakValue').textContent = streak;
        }

        function showFeedback(message, correct) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
        }

        function hideFeedback() {
            document.getElementById('feedback').className = 'feedback';
        }

        function resetChain() {
            chain.forEach(org => {
                document.getElementById(org.paletteId)?.classList.remove('used');
            });
            chain = [];
            renderChain();
            updateHint();
            updateEnergyBar();
            updateChainLengthDisplay();
            hideFeedback();
        }

        // Initialize
        initPalettes();
        updateChainLengthDisplay();
    </script>
</body>
</html>
